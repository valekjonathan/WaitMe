import React, { useEffect, useMemo, useRef, useState } from 'react';\nimport { createPageUrl } from '@/utils';\nimport { useNavigate } from 'react-router-dom';\nimport { base44 } from '@/api/base44Client';\nimport { useQuery } from '@tanstack/react-query';\nimport { Search, X, Navigation, TrendingUp, TrendingDown, MessageCircle } from 'lucide-react';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { toast } from '@/components/ui/use-toast';\nimport { motion } from 'framer-motion';\nimport { format } from 'date-fns';\nimport { es } from 'date-fns/locale';\nimport Header from '@/components/Header';\nimport BottomNav from '@/components/BottomNav';\nimport MarcoCard from '@/components/cards/MarcoCard';\nimport {\n

// Hora en blanco y un poco más grande (solo para el tramo HH:MM)
const WaitUntilText = ({ time }) => (
  <span>
    <span className="text-gray-300">Debes esperar hasta las: </span>
    <span className="text-white text-[15px] font-extrabold">{time}</span>
  </span>
);
\n  isDemoMode,\n  startDemoFlow,\n  subscribeDemoFlow,\n  getDemoConversations,\n  getDemoAlerts\n} from '@/components/DemoFlowManager';\n\n// ======================\n// Helpers\n// ======================\nconst pad2 = (n) => String(n).padStart(2, '0');\n\nconst formatMMSS = (ms) => {\n  const safe = Math.max(0, ms ?? 0);\n  const totalSeconds = Math.floor(safe / 1000);\n  const minutes = Math.floor(totalSeconds / 60);\n  const seconds = totalSeconds % 60;\n  return `${pad2(minutes)}:${pad2(seconds)}`;\n};\n\nconst getChatStatusLabel = (status) => {\n  const s = String(status || '').toLowerCase();\n  switch (s) {\n    case 'completed':\n    case 'completada':\n      return 'COMPLETADA';\n    case 'thinking':\n    case 'me_lo_pienso':\n    case 'pending':\n      return 'ME LO PIENSO';\n    case 'rejected':\n    case 'rechazada':\n      return 'RECHAZADA';\n    case 'extended':\n    case 'prorroga':\n    case 'prórroga':\n      return 'PRÓRROGA';\n    case 'cancelled':\n    case 'canceled':\n    case 'cancelada':\n      return 'CANCELADA';\n    case 'expired':\n    case 'agotada':\n    case 'expirada':\n      return 'AGOTADA';\n    case 'went_early':\n    case 'se_fue':\n      return 'SE FUE';\n    default:\n      return null;\n  }\n};\n\nconst isFinalChatStatus = (status) => {\n  const s = String(status || '').toLowerCase();\n  return ['completed', 'completada', 'cancelled', 'canceled', 'cancelada', 'expired', 'agotada', 'expirada', 'went_early', 'se_fue'].includes(s);\n};\n\n// ====== Estilos sincronizados (CHATS / CHAT / NOTIFICACIONES) ======\nconst PURPLE_ACTIVE_BORDER = 'border-purple-400/70';\nconst PURPLE_ACTIVE_TEXT = 'text-purple-400';\nconst PURPLE_ACTIVE_TEXT_DIM = 'text-purple-400/70';\n\nconst normalizeStatus = (status) => String(status || '').trim().toLowerCase();\n\nconst isStatusMeLoPienso = (status) => {\n  const s = normalizeStatus(status);\n  return s === 'thinking' || s === 'me_lo_pienso' || s === 'me lo pienso' || s === 'pending';\n};\n\nconst isStatusProrrogada = (status) => {\n  const s = normalizeStatus(status);\n  return s === 'extended' || s === 'prorroga' || s === 'prórroga' || s === 'prorrogada';\n};\n\nconst isStatusCancelada = (status) => {\n  const s = normalizeStatus(status);\n  return s === 'cancelled' || s === 'canceled' || s === 'cancelada';\n};\n\nconst isStatusCompletada = (status) => {\n  const s = normalizeStatus(status);\n  return s === 'completed' || s === 'completada';\n};\n\nconst getRoleBoxClasses = ({ status, isSeller, isBuyer }) => {\n  // Caja izquierda: "Te reservo:" (vendes/ganas) o "Reservaste a:" (compras/pagas)\n  const base =\n    'border font-bold text-xs h-7 w-full flex items-center justify-center cursor-default select-none pointer-events-none truncate';\n\n  // COMPLETADAS / CANCELADAS => rojo (ambas)\n  if (isStatusCompletada(status) || isStatusCancelada(status)) {\n    return `${base} bg-red-500/20 text-red-300 border-red-400/50`;\n  }\n\n  // ME LO PIENSO / PRORROGADA => seller verde, buyer morado\n  if (isStatusMeLoPienso(status) || isStatusProrrogada(status)) {\n    if (isSeller) return `${base} bg-green-500/20 text-green-300 border-green-400/50`;\n    if (isBuyer) return `${base} bg-purple-500/20 text-purple-300 border-purple-400/50`;\n  }\n\n  // Por defecto: seller verde (ganas) / buyer morado (pagas) / otros rojo suave\n  if (isSeller) return `${base} bg-green-500/20 text-green-300 border-green-400/50`;\n  if (isBuyer) return `${base} bg-purple-500/20 text-purple-300 border-purple-400/50`;\n  return `${base} bg-red-500/20 text-red-400 border-red-500/30`;\n};\n\nconst PricePill = ({ direction = 'up', amount = 0 }) => {\n  const isUp = direction === 'up';\n  const wrapCls = isUp ? 'bg-green-500/15 border border-green-400/40' : 'bg-red-500/15 border border-red-400/40';\n  const textCls = isUp ? 'text-green-400' : 'text-red-400';\n  return (\n    <div className={`${wrapCls} rounded-lg px-2 py-1 flex items-center gap-1 h-7`}>\n      {isUp ? <TrendingUpIcon className={`w-4 h-4 ${textCls}`} /> : <TrendingDownIcon className={`w-4 h-4 ${textCls}`} />}\n      <span className={`font-bold text-sm ${textCls}`}>{Math.floor(amount || 0)}€</span>\n    </div>\n  );\n};\n\n// Íconos (SVG) para mantener este archivo autocontenido sin tocar imports\nconst TrendingUpIcon = (props) => (\n  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>\n    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />\n    <polyline points="17 6 23 6 23 12" />\n  </svg>\n);\n\nconst TrendingDownIcon = (props) => (\n  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>\n    <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />\n    <polyline points="17 18 23 18 23 12" />\n  </svg>\n);\n\nconst shouldEnableIR = ({ status, isSeller, isFinal }) => {\n  if (isFinal) return false;\n  if (isSeller) return false;\n  // En ME LO PIENSO / PRORROGA el botón debe estar encendido (comprador)\n  if (isStatusMeLoPienso(status) || isStatusProrrogada(status)) return true;\n  // En el resto de estados no finales, también lo dejamos activo (comprador)\n  return true;\n};\n\n\nconst clampFinite = (n, fallback = null) => (Number.isFinite(n) ? n : fallback);\n\nconst getTargetTimeMs = (alert) => {\n  const t = alert?.target_time;\n  if (!t) return null;\n  if (typeof t === 'number') return t;\n  const asDate = new Date(t);\n  const ms = asDate.getTime();\n  return Number.isFinite(ms) ? ms : null;\n};\n\nconst hasLatLon = (obj, latKey = 'latitude', lonKey = 'longitude') => {\n  const lat = clampFinite(Number(obj?.[latKey]));\n  const lon = clampFinite(Number(obj?.[lonKey]));\n  return lat !== null && lon !== null;\n};\n\nconst pickCoords = (obj, latKey = 'latitude', lonKey = 'longitude') => {\n  const lat = clampFinite(Number(obj?.[latKey]));\n  const lon = clampFinite(Number(obj?.[lonKey]));\n  if (lat === null || lon === null) return null;\n  return { lat, lon };\n};\n\nconst PriceChip = ({ amount, direction }) => {\n  const n = Number(amount || 0);\n  const amountText = `${Math.floor(Math.abs(n))}€`;\n  const isGreen = direction === 'up';\n  const isRed = direction === 'down';\n  const wrapCls = isGreen\n    ? 'bg-green-500/20 border border-green-500/30'\n    : isRed\n    ? 'bg-red-500/20 border border-red-500/30'\n    : 'bg-purple-600/20 border border-purple-500/30';\n  const textCls = isGreen ? 'text-green-400' : isRed ? 'text-red-400' : 'text-purple-300';\n  return (\n    <div className={`${wrapCls} rounded-lg px-3 py-0.5 flex items-center gap-1 h-7`}>\n      {isGreen ? <TrendingUp className={`w-4 h-4 ${textCls}`} /> : null}\n      {isRed ? <TrendingDown className={`w-4 h-4 ${textCls}`} /> : null}\n      <span className={`font-bold text-xs ${textCls}`}>{amountText}</span>\n    </div>\n  );\n};\n\n\nexport default function Chats() {\n  const navigate = useNavigate();\n\n  const [user, setUser] = useState(null);\n  const [userLocation, setUserLocation] = useState(null);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [nowTs, setNowTs] = useState(Date.now());\n\n  // Demo “vivo” y sincronizado (CHATS / CHAT / NOTIFICACIONES)\n  const demoMode = useMemo(() => isDemoMode(), []);\n  const [demoTick, setDemoTick] = useState(0);\n\n  useEffect(() => {\n    if (!demoMode) return;\n    startDemoFlow();\n    const unsub = subscribeDemoFlow(() => setDemoTick((t) => t + 1));\n    return () => unsub?.();\n  }, [demoMode]);\n\n  const [showProrrogaDialog, setShowProrrogaDialog] = useState(false);\n  const [selectedProrroga, setSelectedProrroga] = useState(null);\n  const [currentExpiredAlert, setCurrentExpiredAlert] = useState(null);\n\n  const [etaMap, setEtaMap] = useState({});\n\n  const expiredHandledRef = useRef(new Set());\n  const hasEverHadTimeRef = useRef(new Map());\n\n  useEffect(() => {\n    const id = setInterval(() => setNowTs(Date.now()), 1000);\n    return () => clearInterval(id);\n  }, []);\n\n  useEffect(() => {\n    const fetchUser = async () => {\n      try {\n        const currentUser = await base44.auth.me();\n        setUser(currentUser);\n      } catch (error) {\n        console.log('Error:', error);\n        // Si no hay sesión (preview/demo), seguimos con un usuario local.\n        setUser({ id: 'me', display_name: 'Tú', photo_url: null });\n      }\n    };\n    fetchUser();\n\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(\n        (position) => {\n          setUserLocation({ lat: position.coords.latitude, lon: position.coords.longitude });\n        },\n        (error) => console.log('Error obteniendo ubicación:', error),\n        { enableHighAccuracy: true, maximumAge: 15000, timeout: 5000 }\n      );\n    }\n  }, []);\n\n  const { data: conversations = [] } = useQuery({\n    queryKey: ['conversations', user?.id ?? 'none'],\n    queryFn: async () => {\n      return [];\n    },\n    enabled: !!user,\n    staleTime: 1000 * 60 * 5,\n    cacheTime: 1000 * 60 * 30,\n    refetchOnMount: false,\n    refetchOnWindowFocus: false,\n    refetchOnReconnect: false,\n    keepPreviousData: true,\n    refetchInterval: false\n  });\n\n  const { data: alerts = [] } = useQuery({\n    queryKey: ['alertsForChats', user?.id ?? 'none'],\n    queryFn: async () => {\n      return [];\n    },\n    enabled: !!user,\n    staleTime: 1000 * 60 * 5,\n    cacheTime: 1000 * 60 * 30,\n    refetchOnMount: false,\n    refetchOnWindowFocus: false,\n    refetchOnReconnect: false,\n    keepPreviousData: true,\n    refetchInterval: false\n  });\n\n  const alertsMap = useMemo(() => {\n    const map = new Map();\n    alerts.forEach((a) => map.set(a.id, a));\n    return map;\n  }, [alerts]);\n\n  const totalUnread = useMemo(() => {\n    return conversations.reduce((sum, conv) => {\n      const isP1 = conv.participant1_id === user?.id;\n      const unread = isP1 ? conv.unread_count_p1 : conv.unread_count_p2;\n      return sum + (unread || 0);\n    }, 0);\n  }, [conversations, user?.id]);\n\n  const filteredConversations = useMemo(() => {\n    let filtered = conversations;\n\n    if (searchQuery) {\n      const q = searchQuery.toLowerCase();\n      filtered = conversations.filter((conv) => {\n        const isP1 = conv.participant1_id === user?.id;\n        const otherName = isP1 ? conv.participant2_name : conv.participant1_name;\n        const lastMsg = conv.last_message_text || '';\n        return otherName?.toLowerCase().includes(q) || lastMsg.toLowerCase().includes(q);\n      });\n    }\n\n    // Aplicar lógica de negocio: solo UNA reserva activa como buyer y UNA como seller\n    const buyerReservations = [];\n    const sellerReservations = [];\n    const others = [];\n\n    filtered.forEach((conv) => {\n      const alert = alertsMap.get(conv.alert_id);\n      if (!alert) return;\n\n      const isBuyer = alert?.reserved_by_id === user?.id;\n      const isSeller = alert?.user_id === user?.id && alert?.reserved_by_id;\n      const isActive = alert?.status === 'reserved';\n\n      if (isBuyer && isActive) {\n        buyerReservations.push(conv);\n      } else if (isSeller && isActive) {\n        sellerReservations.push(conv);\n      } else {\n        others.push(conv);\n      }\n    });\n\n    // Mantener solo la reserva buyer más reciente como activa\n    if (buyerReservations.length > 1) {\n      buyerReservations.sort((a, b) => new Date(b.last_message_at || b.created_date) - new Date(a.last_message_at || a.created_date));\n      const [activeBuyer, ...restBuyer] = buyerReservations;\n      filtered = filtered.map((conv) => {\n        if (restBuyer.find((c) => c.id === conv.id)) {\n          const alert = alertsMap.get(conv.alert_id);\n          if (alert) alert.status = 'cancelled';\n        }\n        return conv;\n      });\n      buyerReservations.length = 1;\n    }\n\n    // Mantener solo la reserva seller más reciente como activa\n    if (sellerReservations.length > 1) {\n      sellerReservations.sort((a, b) => new Date(b.last_message_at || b.created_date) - new Date(a.last_message_at || a.created_date));\n      const [activeSeller, ...restSeller] = sellerReservations;\n      filtered = filtered.map((conv) => {\n        if (restSeller.find((c) => c.id === conv.id)) {\n          const alert = alertsMap.get(conv.alert_id);\n          if (alert) alert.status = 'cancelled';\n        }\n        return conv;\n      });\n      sellerReservations.length = 1;\n    }\n\n    return filtered.sort((a, b) => {\n      const aUnread = (a.participant1_id === user?.id ? a.unread_count_p1 : a.unread_count_p2) || 0;\n      const bUnread = (b.participant1_id === user?.id ? b.unread_count_p1 : b.unread_count_p2) || 0;\n\n      if (bUnread !== aUnread) return bUnread - aUnread;\n\n      const toMs = (v) => {\n        if (!v) return 0;\n        if (typeof v === 'number') return v;\n        const d = new Date(v);\n        const ms = d.getTime();\n        return Number.isFinite(ms) ? ms : 0;\n      };\n\n      const aLast = Math.max(\n        toMs(a.last_message_at),\n        toMs(a.status_updated_at),\n        toMs(a.updated_date),\n        toMs(a.updated_at),\n        toMs(a.created_date),\n        toMs(a.created_at)\n      );\n\n      const bLast = Math.max(\n        toMs(b.last_message_at),\n        toMs(b.status_updated_at),\n        toMs(b.updated_date),\n        toMs(b.updated_at),\n        toMs(b.created_date),\n        toMs(b.created_at)\n      );\n\n      return bLast - aLast;\n    });\n  }, [conversations, searchQuery, user?.id, alertsMap]);\n\n  const openExpiredDialog = (alert, isBuyer) => {\n    if (!alert?.id) return;\n    if (expiredHandledRef.current.has(alert.id)) return;\n    expiredHandledRef.current.add(alert.id);\n\n    const title = isBuyer ? '⏱️ No te has presentado' : '⏱️ Usuario no se ha presentado';\n    const desc = isBuyer\n      ? 'No te has presentado, se te devolverá tu importe menos la comisión de WaitMe!'\n      : 'Usuario no se ha presentado, se te ingresará el 33% del importe de la operación como compensación por tu espera';\n\n    toast({ title, description: desc });\n\n    setCurrentExpiredAlert({ alert, isBuyer });\n    setSelectedProrroga(null);\n    setShowProrrogaDialog(true);\n  };\n\n  const handleProrroga = async () => {\n    if (!selectedProrroga || !currentExpiredAlert) return;\n\n    const { minutes, price } = selectedProrroga;\n    const { alert, isBuyer } = currentExpiredAlert;\n\n    try {\n      await base44.entities.Notification.create({\n        type: 'extension_request',\n        recipient_id: isBuyer ? alert.user_id : alert.reserved_by_id,\n        sender_id: user?.id,\n        sender_name: user?.display_name || user?.full_name?.split(' ')[0] || 'Usuario',\n        alert_id: alert.id,\n        amount: price,\n        extension_minutes: minutes,\n        status: 'pending'\n      });\n\n      toast({\n        title: '✅ PRÓRROGA ENVIADA',\n        description: `${minutes} min por ${price}€`\n      });\n    } catch (err) {\n      console.error('Error creando notificación de prórroga:', err);\n      toast({\n        title: 'Error',\n        description: 'No se pudo enviar la prórroga. Inténtalo de nuevo.',\n        variant: 'destructive'\n      });\n    }\n\n    setShowProrrogaDialog(false);\n    setSelectedProrroga(null);\n    setCurrentExpiredAlert(null);\n  };\n\n  const calculateDistanceText = (alert) => {\n    if (!alert?.latitude || !alert?.longitude) return null;\n    if (!userLocation) {\n      const demoDistances = ['150m', '320m', '480m', '650m', '800m'];\n      return demoDistances[String(alert.id || '').charCodeAt(0) % demoDistances.length];\n    }\n    const R = 6371;\n    const dLat = ((alert.latitude - userLocation.lat) * Math.PI) / 180;\n    const dLon = ((alert.longitude - userLocation.lon) * Math.PI) / 180;\n    const a =\n      Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n      Math.cos((userLocation.lat * Math.PI) / 180) *\n        Math.cos((alert.latitude * Math.PI) / 180) *\n        Math.sin(dLon / 2) *\n        Math.sin(dLon / 2);\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    const distanceKm = R * c;\n    const meters = Math.round(distanceKm * 1000);\n    return `${Math.min(meters, 999)}m`;\n  };\n\n  const openDirectionsToAlert = (alert) => {\n    const coords = hasLatLon(alert) ? pickCoords(alert) : null;\n    if (!coords) return;\n    const { lat, lon } = coords;\n    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;\n    window.location.href = url;\n  };\n\n  const getRemainingMsForAlert = (alert, isBuyer) => {\n    const entry = etaMap?.[alert?.id];\n\n    if (entry && Number.isFinite(entry.etaSeconds)) {\n      const elapsed = nowTs - entry.fetchedAt;\n      const base = entry.etaSeconds * 1000;\n      const remaining = Math.max(0, base - elapsed);\n\n      if (base > 0) {\n        hasEverHadTimeRef.current.set(alert.id, true);\n      }\n\n      return remaining;\n    }\n\n    const targetMs = getTargetTimeMs(alert);\n    if (targetMs && targetMs > nowTs) {\n      hasEverHadTimeRef.current.set(alert.id, true);\n      return targetMs - nowTs;\n    }\n\n    return null;\n  };\n\n  useEffect(() => {\n    const max = 25;\n    for (const conv of filteredConversations.slice(0, max)) {\n      const alert = alertsMap.get(conv.alert_id);\n      if (!alert) continue;\n      const isBuyer = alert?.reserved_by_id === user?.id;\n      const remainingMs = getRemainingMsForAlert(alert, isBuyer);\n            const statusLabel = getChatStatusLabel(alert?.status);\nconst isCompletedOrCanceled = statusLabel === 'COMPLETADA' || statusLabel === 'CANCELADA';\nconst isThinking = statusLabel === 'ME LO PIENSO';\nconst isProrroga = statusLabel === 'PRÓRROGA';\n\nconst isSeller = alert?.user_id === user?.id;\n\nconst badgeCls = isCompletedOrCanceled\n  ? 'bg-red-500/20 text-red-400 border-red-500/30'\n  : isBuyer\n  ? 'bg-purple-500/20 text-purple-300 border-purple-400/50'\n  : isSeller\n  ? 'bg-green-500/20 text-green-300 border-green-400/50'\n  : 'bg-purple-500/10 text-purple-300/70 border-purple-400/30';\n\n\n      if (remainingMs === 0 && hasEverHadTimeRef.current.get(alert.id) === true && !showProrrogaDialog) {\n        openExpiredDialog(alert, isBuyer);\n      }\n    }\n  }, [nowTs, filteredConversations, alertsMap, user?.id, showProrrogaDialog]);\n\n  return (\n    <div className="min-min-h-[100dvh] bg-black text-white flex flex-col">\n      <Header title="Chats" showBackButton={true} backTo="Home" unreadCount={totalUnread} />\n\n      <main className="pt-[60px] pb-24">\n        {filteredConversations.length === 0 ? (\n          <div className="min-h-[calc(100vh-60px-96px)] flex items-center justify-center px-4">\n            <div className="text-center">\n              <MessageCircle className="w-16 h-16 text-purple-400 mx-auto mb-4" />\n              <p className="text-gray-400 text-sm">No hay chats iniciados.</p>\n            </div>\n          </div>\n        ) : (\n          <>\n\n        <div className="px-4 pt-3 pb-2">\n          <div className="relative">\n            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-purple-400" />\n            <input\n              type="text"\n              placeholder="Buscar conversaciones..."\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className="w-full bg-gray-900 border border-gray-700 text-white pl-10 pr-10 py-2 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"\n            />\n            {searchQuery && (\n              <button\n                onClick={() => setSearchQuery('')}\n                className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"\n              >\n                <X className="w-4 h-4" />\n              </button>\n            )}\n          </div>\n        </div>\n\n        <div className="px-4 space-y-3 pt-1">\n          {filteredConversations.map((conv, index) => {\n            const alert = alertsMap.get(conv.alert_id);\n            if (!alert) return null;\n\n            const isP1 = conv.participant1_id === user?.id;\n            const unreadCount = isP1 ? conv.unread_count_p1 : conv.unread_count_p2;\n            const hasUnread = (unreadCount || 0) > 0;\n\n            const isBuyer = alert?.reserved_by_id === user?.id;\n            const isSeller = alert?.reserved_by_id && !isBuyer;\n\n            const otherUserName = isP1 ? conv.participant2_name : conv.participant1_name;\n            let otherUserPhoto = isP1 ? conv.participant2_photo : conv.participant1_photo;\n\n            if (!otherUserPhoto) {\n              const photoUrls = [\n                'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=400&fit=crop',\n                'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop',\n                'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop',\n                'https://randomuser.me/api/portraits/women/68.jpg',\n                'https://randomuser.me/api/portraits/men/32.jpg',\n                'https://randomuser.me/api/portraits/women/44.jpg',\n                'https://randomuser.me/api/portraits/men/75.jpg'\n              ];\n              otherUserPhoto = photoUrls[String(conv.id || '').charCodeAt(0) % photoUrls.length];\n            }\n\n            const distanceText = calculateDistanceText(alert);\n\n            const remainingMs = getRemainingMsForAlert(alert, isBuyer);\n            const countdownText = formatMMSS(remainingMs);\n\n            const remainingMinutes = Math.max(0, Math.ceil((remainingMs ?? 0) / 60000));\n            const waitUntilText = format(new Date(nowTs + (remainingMs ?? 0)), 'HH:mm', { locale: es });\n\n            const finalLabel = getChatStatusLabel(alert?.status);\n            const isFinal = isFinalChatStatus(alert?.status) && !!finalLabel;\n            const canIR = shouldEnableIR({ status: alert?.status, isSeller, isFinal });\n            const statusBoxText = isFinal ? finalLabel : countdownText;\n\n            const navigateToChat = () => {\n              const name = encodeURIComponent(otherUserName || '');\n              const photo = encodeURIComponent(otherUserPhoto || '');\n              const demo = demoMode ? 'demo=true&' : '';\n              const alertIdParam = conv.alert_id ? `&alertId=${encodeURIComponent(conv.alert_id)}` : '';\n              navigate(createPageUrl(`Chat?${demo}conversationId=${conv.id}${alertIdParam}&otherName=${name}&otherPhoto=${photo}`));\n            };\n\n            return (\n              <motion.div\n                key={conv.id}\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: index * 0.05 }}\n              >\n                <div\n                  className={`bg-gradient-to-br ${\n                    hasUnread ? 'from-gray-800 to-gray-900' : 'from-gray-900/50 to-gray-900/50'\n                  } rounded-xl p-2.5 transition-all border-2 ${\n                    hasUnread ? 'border-purple-400/70' : 'border-purple-500/30'\n                  }`}\n                >\n                  <div className="flex flex-col h-full">\n                    <div className="flex items-center gap-2 mb-2">\n                      <div className="flex-shrink-0 w-[95px]">\n                        <Badge\n                          className={getRoleBoxClasses({ status: alert?.status, isSeller, isBuyer })}\n                        >\n                          {isBuyer ? 'Reservaste a:' : isSeller ? 'Te reservo:' : 'Info usuario'}\n                        </Badge>\n                      </div>\n                      <div className="flex-1"></div>\n                      <div className="bg-black/40 backdrop-blur-sm border border-purple-500/30 rounded-full px-2 py-0.5 flex items-center gap-1 h-7">\n                        <Navigation className="w-3 h-3 text-purple-400" />\n                        <span className="text-white font-bold text-xs">{distanceText}</span>\n                      </div>\n                      <PricePill direction={isSeller ? 'up' : 'down'} amount={alert?.price} />\n                      <button\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          console.log('Cerrar conversación:', conv.id);\n                        }}\n                        className="w-7 h-7 rounded-lg bg-red-500/20 border border-red-500/30 hover:bg-red-500/30 flex items-center justify-center transition-colors"\n                      >\n                        <X className="w-3.5 h-3.5 text-red-400" />\n                      </button>\n                    </div>\n\n                    <div className="border-t border-gray-700/80 mb-1.5 pt-2">\n                      <MarcoCard\n                        photoUrl={otherUserPhoto}\n                        name={otherUserName}\n                        carLabel={`${alert.car_brand || ''} ${alert.car_model || ''}`.trim()}\n                        plate={alert.car_plate}\n                        carColor={alert.car_color || 'gris'}\n                        address={alert.address}\n                        timeLine={\n                          isSeller ? (\n                            <span className={hasUnread ? 'text-white' : 'text-gray-400'}>\n                              Te vas en {remainingMinutes} min ·{' '}\n                              <span className="text-purple-300 font-bold">Debes esperar hasta las {waitUntilText}</span>\n                            </span>\n                          ) : isBuyer ? (\n                            <span className={hasUnread ? 'text-white' : 'text-gray-400'}>\n                              Se va en {remainingMinutes} min ·{' '}\n                              <span className="text-purple-300 font-bold">Te espera hasta las {waitUntilText}</span>\n                            </span>\n                          ) : (\n                            <span className={hasUnread ? 'text-white' : 'text-gray-400'}>Tiempo para llegar:</span>\n                          )\n                        }\n                        onChat={navigateToChat}\n                        statusText={statusBoxText}\n                        phoneEnabled={alert.allow_phone_calls}\n                        onCall={() => alert.allow_phone_calls && alert?.phone && (window.location.href = `tel:${alert.phone}`)}\n                        dimmed={!hasUnread}\n                        role={isSeller ? 'seller' : 'buyer'}\n                      />\n\n                      {hasLatLon(alert) && (\n                        <div className="mt-2">\n                          <Button\n                            disabled={!canIR}\n                            className={`w-full border-2 ${\n                              canIR ? 'bg-blue-600 hover:bg-blue-700 border-blue-400/70' : 'bg-blue-600/30 text-white/50 border-blue-500/30'\n                            }`}\n                            onClick={(e) => {\n                              e.preventDefault();\n                              e.stopPropagation();\n                              if (isSeller || isFinal) return;\n                              openDirectionsToAlert(alert);\n                            }}\n                          >\n                            <span className="flex items-center justify-center gap-2">\n                              <Navigation className="w-4 h-4" />\n                              IR\n                            </span>\n                          </Button>\n                        </div>\n                      )}\n                    </div>\n\n                    <div\n                      className="border-t border-gray-700/80 mt-2 pt-2 cursor-pointer hover:opacity-80 transition-opacity"\n                      onClick={navigateToChat}\n                    >\n                      <div className="flex justify-between items-center">\n                        <p className={`text-xs font-bold ${hasUnread ? PURPLE_ACTIVE_TEXT : PURPLE_ACTIVE_TEXT_DIM}`}>\n                          Últimos mensajes:\n                        </p>\n                        {unreadCount > 0 && (\n                          <div className="w-6 h-6 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center relative top-[10px]">\n                            <span className="text-red-400 text-xs font-bold">{unreadCount > 9 ? '9+' : unreadCount}</span>\n                          </div>\n                        )}\n                      </div>\n                      <p className={`text-xs ${hasUnread ? 'text-gray-300' : 'text-gray-500'} mt-1`}>\n                        {conv.last_message_text || 'Sin mensajes'}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </motion.div>\n            );\n          })}\n        </div>\n      \n          </>\n        )}\n</main>\n\n      <BottomNav />\n\n      <Dialog\n        open={showProrrogaDialog}\n        onOpenChange={(open) => {\n          setShowProrrogaDialog(open);\n          if (!open) {\n            setSelectedProrroga(null);\n            setCurrentExpiredAlert(null);\n            expiredHandledRef.current.clear();\n          }\n        }}\n      >\n        <DialogContent className="bg-gray-900 border-gray-800 text-white max-w-sm">\n          <DialogHeader>\n            <DialogTitle className="text-xl">\n              {currentExpiredAlert?.isBuyer ? '⏱️ No te has presentado' : '⏱️ Usuario no se ha presentado'}\n            </DialogTitle>\n            <DialogDescription className="text-gray-400">\n              {currentExpiredAlert?.isBuyer\n                ? 'No te has presentado, se te devolverá tu importe menos la comisión de WaitMe!'\n                : 'Usuario no se ha presentado, se te ingresará el 33% del importe de la operación como compensación por tu espera'}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className="space-y-3">\n            <p className="text-sm text-gray-300 font-semibold">PRORROGAR</p>\n\n            <div className="space-y-2">\n              <button\n                onClick={() => setSelectedProrroga({ minutes: 5, price: 1 })}\n                className={`w-full p-3 rounded-lg border-2 transition-all ${\n                  selectedProrroga?.minutes === 5\n                    ? 'bg-purple-600/20 border-purple-500 text-white'\n                    : 'bg-gray-800 border-gray-700 text-gray-300 hover:border-purple-500/50'\n                }`}\n              >\n                <div className="flex justify-between items-center">\n                  <span className="font-semibold">5 minutos más</span>\n                  <span className="text-purple-300 font-bold">1€</span>\n                </div>\n              </button>\n\n              <button\n                onClick={() => setSelectedProrroga({ minutes: 10, price: 3 })}\n                className={`w-full p-3 rounded-lg border-2 transition-all ${\n                  selectedProrroga?.minutes === 10\n                    ? 'bg-purple-600/20 border-purple-500 text-white'\n                    : 'bg-gray-800 border-gray-700 text-gray-300 hover:border-purple-500/50'\n                }`}\n              >\n                <div className="flex justify-between items-center">\n                  <span className="font-semibold">10 minutos más</span>\n                  <span className="text-purple-300 font-bold">3€</span>\n                </div>\n              </button>\n\n              <button\n                onClick={() => setSelectedProrroga({ minutes: 15, price: 5 })}\n                className={`w-full p-3 rounded-lg border-2 transition-all ${\n                  selectedProrroga?.minutes === 15\n                    ? 'bg-purple-600/20 border-purple-500 text-white'\n                    : 'bg-gray-800 border-gray-700 text-gray-300 hover:border-purple-500/50'\n                }`}\n              >\n                <div className="flex justify-between items-center">\n                  <span className="font-semibold">15 minutos más</span>\n                  <span className="text-purple-300 font-bold">5€</span>\n                </div>\n              </button>\n            </div>\n          </div>\n\n          <DialogFooter className="flex gap-3">\n            <Button variant="outline" onClick={() => setShowProrrogaDialog(false)} className="flex-1 border-gray-700">\n              {currentExpiredAlert?.isBuyer ? 'ACEPTAR DEVOLUCIÓN' : 'ACEPTAR COMPENSACIÓN'}\n            </Button>\n            <Button\n              onClick={handleProrroga}\n              className="flex-1 bg-purple-600 hover:bg-purple-700"\n              disabled={!selectedProrroga}\n            >\n              PRORROGAR\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}