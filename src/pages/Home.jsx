import React, { useState, useEffect, useMemo, useCallback } from 'react';\nimport { useNavigate, useLocation } from 'react-router-dom';\nimport { createPageUrl } from '@/utils';\nimport { base44 } from '@/api/base44Client';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { SlidersHorizontal, MapPin, Clock, Euro, X } from 'lucide-react';\nimport Header from '@/components/Header';\nimport BottomNav from '@/components/BottomNav';\nimport ParkingMap from '@/components/map/ParkingMap';\nimport MapFilters from '@/components/map/MapFilters';\nimport CreateAlertCard from '@/components/cards/CreateAlertCard';\nimport UserAlertCard from '@/components/cards/UserAlertCard';\nimport NotificationManager from '@/components/NotificationManager';\nimport { isDemoMode, startDemoFlow, subscribeDemoFlow, getDemoAlerts, getDemoMarketAlerts, scheduleIncomingWaitMeRequest } from '@/components/DemoFlowManager';\nimport appLogo from '@/assets/d2ae993d3_WaitMe.png';\n

// Hora en blanco y un poco más grande (solo para el tramo HH:MM)
const WaitUntilText = ({ time }) => (
  <span>
    <span className="text-gray-300">Debes esperar hasta las: </span>
    <span className="text-white text-[15px] font-extrabold">{time}</span>
  </span>
);
\n\n// ======================\n// Helpers\n// ======================\nconst FALLBACK_LAT = 43.3623; // Oviedo\nconst FALLBACK_LNG = -5.8489; // Oviedo\n\n\n// ======================\nconst calculateDistance = (lat1, lon1, lat2, lon2) => {\n  const R = 6371;\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLon = (lon2 - lon1) * Math.PI / 180;\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n};\n\nconst buildDemoAlerts = (lat, lng) => {\n  return [];\n};\n\nconst CarIconProfile = ({ color, size = "w-16 h-10" }) =>\n  <svg viewBox="0 0 48 24" className={size} fill="none">\n    {/* Cuerpo del coche - vista lateral */}\n    <path\n      d="M8 16 L10 10 L16 8 L32 8 L38 10 L42 14 L42 18 L8 18 Z"\n      fill={color}\n      stroke="white"\n      strokeWidth="1.5" />\n\n    {/* Ventanas */}\n    <path d="M16 9 L18 12 L30 12 L32 9 Z" fill="rgba(255,255,255,0.3)" stroke="white" strokeWidth="0.5" />\n    {/* Rueda trasera */}\n    <circle cx="14" cy="18" r="4" fill="#333" stroke="white" strokeWidth="1" />\n    <circle cx="14" cy="18" r="2" fill="#666" />\n    {/* Rueda delantera */}\n    <circle cx="36" cy="18" r="4" fill="#333" stroke="white" strokeWidth="1" />\n    <circle cx="36" cy="18" r="2" fill="#666" />\n  </svg>;\n\nconst MagnifierIconProfile = ({ color = "#8b5cf6", size = "w-14 h-14" }) => (\n  <svg viewBox="0 0 48 48" className={size} fill="none">\n    {/* Lente */}\n    <circle cx="20" cy="20" r="12" fill={color} stroke="white" strokeWidth="1.5" />\n    {/* Brillo */}\n    <path d="M15 16 C16 13, 18 12, 21 12" stroke="rgba(255,255,255,0.45)" strokeWidth="2" strokeLinecap="round" />\n    {/* Mango */}\n    <path d="M28 28 L38 38" stroke="white" strokeWidth="4" strokeLinecap="round" />\n    {/* Tope mango */}\n    <path d="M36.8 36.8 L40.8 40.8" stroke="white" strokeWidth="6" strokeLinecap="round" opacity="0.9" />\n  </svg>\n);\n\nexport default function Home() {\n  const queryClient = useQueryClient();\n  const navigate = useNavigate();\n  const location = useLocation();\n  const [mode, setMode] = useState(null);\n  // null | 'search' | 'create'\n\n  const [confirmPublishOpen, setConfirmPublishOpen] = useState(false);\n  const [pendingPublishPayload, setPendingPublishPayload] = useState(null);\n  const [oneActiveAlertOpen, setOneActiveAlertOpen] = useState(false);\nconst [demoTick, setDemoTick] = useState(0);\n  const [selectedAlert, setSelectedAlert] = useState(null);\n  const [userLocation, setUserLocation] = useState(null);\n  const [selectedPosition, setSelectedPosition] = useState(null);\n  const [address, setAddress] = useState('');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [showFilters, setShowFilters] = useState(false);\n  const [confirmDialog, setConfirmDialog] = useState({ open: false, alert: null });\n\n  const [filters, setFilters] = useState({\n    maxPrice: 10,\n    maxMinutes: 30,\n    maxDistance: 10\n  });\n\n  // BLINDADO: resetea SIEMPRE al logo (los 2 botones grandes), sin tocar la UI del logo.\n  const resetToLogo = useCallback((opts = { invalidate: true }) => {\n    setMode(null);\n    setSelectedAlert(null);\n    setShowFilters(false);\n    setConfirmDialog({ open: false, alert: null });\n    setSearchQuery('');\n    if (opts?.invalidate) queryClient.invalidateQueries();\n  }, [queryClient]);\n\n  // Botón "Mapa": escucha el evento global y vuelve al logo SIEMPRE.\n  useEffect(() => {\n    const goLogo = () => resetToLogo({ invalidate: true });\n    window.addEventListener('waitme:goLogo', goLogo);\n    return () => window.removeEventListener('waitme:goLogo', goLogo);\n  }, [resetToLogo]);\n\n  const { data: user } = useQuery({\n    queryKey: ['user'],\n    queryFn: () => base44.auth.me(),\n    staleTime: 5 * 60 * 1000,\n    gcTime: 10 * 60 * 1000,\n    refetchOnWindowFocus: true,\n    refetchOnMount: true\n  });\n\n  const { data: unreadCount } = useQuery({\n    queryKey: ['unreadCount', user?.id],\n    enabled: !!user?.id,\n    queryFn: async () => {\n      const notifications = await base44.entities.Notification.filter({\n        user_id: user.id,\n        read: false\n      });\n      return notifications?.length || 0;\n    },\n    staleTime: 0,\n    gcTime: 5 * 60 * 1000,\n    refetchInterval: 3000,\n    refetchOnWindowFocus: true,\n    refetchOnMount: true\n  });\n\n  const { data: rawAlerts } = useQuery({\n    queryKey: ['alerts'],\n    queryFn: async () => {\n      if (isDemoMode()) {\n        startDemoFlow();\n        return getDemoMarketAlerts();\n      }\n      return [];\n    },\n    staleTime: 0,\n    gcTime: 10 * 60 * 1000,\n    refetchInterval: 3000,\n    refetchOnWindowFocus: true,\n    refetchOnMount: true\n  });\n\n  // Una sola fuente de verdad (también alimenta la bolita del BottomNav)\n  const { data: myAlerts = [] } = useQuery({\n    queryKey: ['myAlerts'],\n    enabled: true,\n    staleTime: 30 * 1000,\n    gcTime: 5 * 60 * 1000,\n    refetchInterval: false,\n    refetchOnWindowFocus: false,\n    refetchOnMount: false,\n    placeholderData: (prev) => prev,\n    queryFn: async () => {\n      const uid = user?.id;\n      const email = user?.email;\n      if (!uid && !email) return [];\n\n      if (uid) return (await base44.entities.ParkingAlert.filter({ user_id: uid })) || [];\n      return (await base44.entities.ParkingAlert.filter({ user_email: email })) || [];\n    }\n  });\n\n  const myActiveAlerts = useMemo(() => {\n    return (myAlerts || []).filter((a) => {\n      const st = String(a?.status || '').toLowerCase();\n      return st === 'active' || st === 'reserved';\n    });\n  }, [myAlerts]);\n\n  useEffect(() => {\n    if (!user?.id && !user?.email) return;\n    queryClient.invalidateQueries({ queryKey: ['myAlerts'] });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [user?.id, user?.email]);\n\n  const getCurrentLocation = () => {\n    if (!navigator.geolocation) return;\n\n    navigator.geolocation.getCurrentPosition(\n      (pos) => {\n        const { latitude, longitude } = pos.coords;\n        setUserLocation([latitude, longitude]);\n        setSelectedPosition({ lat: latitude, lng: longitude });\n\n        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)\n          .then((res) => res.json())\n          .then((data) => {\n            if (data?.address) {\n              const road = data.address.road || data.address.street || '';\n              const number = data.address.house_number || '';\n              setAddress(number ? `${road}, ${number}` : road);\n            }\n          })\n          .catch(() => {});\n      },\n      () => {\n        // iOS PWA a veces deniega/retarda la geo: ponemos fallback para que SIEMPRE haya mapa + tarjetas.\n        setUserLocation([FALLBACK_LAT, FALLBACK_LNG]);\n        setSelectedPosition({ lat: FALLBACK_LAT, lng: FALLBACK_LNG });\n        if (!address) setAddress('Oviedo');\n      },\n      { enableHighAccuracy: false, timeout: 5000, maximumAge: 10 * 60 * 1000 }\n    );\n  };\n\n  useEffect(() => {\n    getCurrentLocation();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Defensa extra: si el logo falla al cargar (iOS/Safari a veces), reintenta 1 vez.\n  const handleLogoError = () => {\n    if (logoRetryCount >= 1) return;\n    setLogoRetryCount((c) => c + 1);\n};\n\n  useEffect(() => {\n    if (!isDemoMode()) return;\n    startDemoFlow();\n    const unsub = subscribeDemoFlow(() => setDemoTick((t) => t + 1));\n    return () => unsub?.();\n  }, []);\n\n  useEffect(() => {\n    const urlParams = new URLSearchParams(location.search);\n    if (urlParams.get('reset')) {\n      resetToLogo({ invalidate: false });\n      window.history.replaceState({}, '', window.location.pathname);\n    }\n  }, [location.search, resetToLogo]);\n\n  const homeMapAlerts = useMemo(() => {\n    return [];\n  }, []);\n\n  const filteredAlerts = useMemo(() => {\n    const list = Array.isArray(rawAlerts) ? rawAlerts : [];\n    const [uLat, uLng] = Array.isArray(userLocation) ? userLocation : [null, null];\n\n    return list.filter((a) => {\n      if (!a) return false;\n\n      const price = Number(a.price);\n      if (Number.isFinite(price) && price > filters.maxPrice) return false;\n\n      const mins = Number(a.available_in_minutes ?? a.availableInMinutes);\n      if (Number.isFinite(mins) && mins > filters.maxMinutes) return false;\n\n      const lat = a.latitude ?? a.lat;\n      const lng = a.longitude ?? a.lng;\n\n      if (uLat != null && uLng != null && lat != null && lng != null) {\n        const km = calculateDistance(uLat, uLng, lat, lng);\n        if (Number.isFinite(km) && km > filters.maxDistance) return false;\n      }\n      return true;\n    });\n  }, [rawAlerts, filters, userLocation]);\n\n  const searchAlerts = useMemo(() => {\n    if (mode !== 'search') return [];\n    return filteredAlerts || [];\n  }, [mode, filteredAlerts]);\n\n  const createAlertMutation = useMutation({\n  mutationFn: async (data) => {\n    if (myActiveAlerts && myActiveAlerts.length > 0) {\n      throw new Error('ALREADY_HAS_ALERT');\n    }\n\n    const uid = user?.id;\n    const email = user?.email;\n\n    if (uid || email) {\n      const mine = uid\n        ? await base44.entities.ParkingAlert.filter({ user_id: uid })\n        : await base44.entities.ParkingAlert.filter({ user_email: email });\n\n      const hasActive = (mine || []).some((a) => {\n        const st = String(a?.status || '').toLowerCase();\n        return st === 'active' || st === 'reserved';\n      });\n\n      if (hasActive) {\n        throw new Error('ALREADY_HAS_ALERT');\n      }\n    }\n\n    const now = Date.now();\n    const futureTime = new Date(now + data.available_in_minutes * 60 * 1000);\n\n    return base44.entities.ParkingAlert.create({\n      user_id: user?.id,\n      user_email: user?.email,\n      user_name: data.user_name,\n      user_photo: data.user_photo,\n      latitude: data.latitude,\n      longitude: data.longitude,\n      address: data.address,\n      price: data.price,\n      available_in_minutes: data.available_in_minutes,\n      car_brand: data.car_brand || '',\n      car_model: data.car_model || '',\n      car_color: data.car_color || '',\n      car_plate: data.car_plate || '',\n      phone: data.phone,\n      allow_phone_calls: data.allow_phone_calls,\n      wait_until: futureTime.toISOString(),\n      created_from: 'parked_here',\n      status: 'active'\n    });\n  },\n\n  onMutate: async (data) => {\n    navigate(createPageUrl('History'), { replace: true });\n\n    await queryClient.cancelQueries({ queryKey: ['alerts'] });\n    await queryClient.cancelQueries({ queryKey: ['myAlerts'] });\n\n    const now = Date.now();\n    const futureTime = new Date(now + data.available_in_minutes * 60 * 1000);\n\n    const optimisticAlert = {\n      id: `temp_${Date.now()}`,\n      ...data,\n      wait_until: futureTime.toISOString(),\n      created_from: 'parked_here',\n      status: 'active',\n      created_date: new Date().toISOString()\n    };\n\n    queryClient.setQueryData(['alerts'], (old) => {\n      const list = Array.isArray(old) ? old : (old?.data || []);\n      return [optimisticAlert, ...list];\n    });\n\n    queryClient.setQueryData(['myAlerts'], (old) => {\n      const list = Array.isArray(old) ? old : (old?.data || []);\n      return [optimisticAlert, ...list];\n    });\n\n    try {\n      window.dispatchEvent(new Event('waitme:badgeRefresh'));\n    } catch {}\n  },\n\n  onSuccess: (newAlert) => {\n    queryClient.setQueryData(['alerts'], (old) => {\n      const list = Array.isArray(old) ? old : (old?.data || []);\n      return [newAlert, ...list.filter(a => !a.id?.startsWith('temp_'))];\n    });\n\n    queryClient.setQueryData(['myAlerts'], (old) => {\n      const list = Array.isArray(old) ? old : (old?.data || []);\n      return [newAlert, ...list.filter(a => !a.id?.startsWith('temp_'))];\n    });\n\n    try {\n      window.dispatchEvent(new Event('waitme:badgeRefresh'));\n    } catch {}\n  },\n\n  onSuccess: (createdAlert) => {\n    // DEMO: a los 60s entra una solicitud de reserva\n    try {\n      if (isDemoMode()) {\n        startDemoFlow();\n        // si estamos en demo, sincroniza la alerta activa con el id real\n        const demoAlerts = getDemoAlerts();\n        const active = (demoAlerts || []).find((a) => String(a?.status || '').toLowerCase() === 'active');\n        if (active && createdAlert?.id) active.id = createdAlert.id;\n        scheduleIncomingWaitMeRequest(createdAlert?.id || active?.id);\n      }\n    } catch {}\n  },\n\n  onError: (error) => {\n    if (error?.message === 'ALREADY_HAS_ALERT') {\n      // CERRAMOS CUALQUIER DIALOG ABIERTO\n      setConfirmPublishOpen(false);\n      setPendingPublishPayload(null);\n\n      // ABRIMOS SOLO EL MENSAJE MORADO\n      setOneActiveAlertOpen(true);\n      return;\n    }\n\n    queryClient.invalidateQueries({ queryKey: ['alerts'] });\n    queryClient.invalidateQueries({ queryKey: ['myAlerts'] });\n  }\n});\n\n  const buyAlertMutation = useMutation({\n    mutationFn: async (alert) => {\n      if (alert?.is_demo) {\n        return { demo: true };\n      }\n\n      const buyerName = user?.full_name || user?.display_name || 'Usuario';\n      const buyerCarBrand = user?.car_brand || '';\n      const buyerCarModel = user?.car_model || '';\n      const buyerCarColor = user?.car_color || 'gris';\n      const buyerPlate = user?.car_plate || '';\n      const buyerVehicleType = user?.vehicle_type || 'car';\n\n      return Promise.all([\n        base44.entities.ParkingAlert.update(alert.id, {\n          status: 'reserved',\n          reserved_by_id: user?.id,\n          reserved_by_email: user?.email,\n          reserved_by_name: buyerName,\n          reserved_by_car: `${buyerCarBrand} ${buyerCarModel}`.trim(),\n          reserved_by_car_color: buyerCarColor,\n          reserved_by_plate: buyerPlate,\n          reserved_by_vehicle_type: buyerVehicleType\n        }),\n        base44.entities.Transaction.create({\n          alert_id: alert.id,\n          buyer_id: user?.id,\n          seller_id: alert.user_id || alert.created_by,\n          amount: Number(alert.price) || 0,\n          status: 'pending'\n        }),\n        base44.entities.ChatMessage.create({\n          conversation_id: `conv_${alert.id}_${user?.id}`,\n          alert_id: alert.id,\n          sender_id: user?.id,\n          receiver_id: alert.user_id || alert.created_by,\n          message: `Ey! Te he enviado un WaitMe!`,\n          read: false\n        })\n      ]);\n    },\n    onMutate: async (alert) => {\n      setConfirmDialog({ open: false, alert: null });\n      navigate(createPageUrl('History'));\n\n      await queryClient.cancelQueries({ queryKey: ['alerts'] });\n\n      const previousAlerts = queryClient.getQueryData(['alerts']);\n\n      queryClient.setQueryData(['alerts'], (old) => {\n        const list = Array.isArray(old) ? old : (old?.data || []);\n        return list.map(a => a.id === alert.id ? { ...a, status: 'reserved', reserved_by_id: user?.id } : a);\n      });\n\n      return { previousAlerts };\n    },\n    onError: (err, alert, context) => {\n      if (context?.previousAlerts) {\n        queryClient.setQueryData(['alerts'], context.previousAlerts);\n      }\n      setSelectedAlert(null);\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: ['alerts'] });\n      queryClient.invalidateQueries({ queryKey: ['myAlerts'] });\n      try { window.dispatchEvent(new Event('waitme:badgeRefresh')); } catch {}\n    }\n  });\n\n  const handleBuyAlert = (alert) => {\n    setConfirmDialog({ open: true, alert });\n  };\n\n  const handleChat = async () => {\n    navigate(createPageUrl('History'));\n  };\n\n  const handleCall = async () => {\n    navigate(createPageUrl('History'));\n  };\n\n  return (\n    <div className="min-min-h-[100dvh] w-full bg-black text-white flex flex-col">\n      <NotificationManager user={user} />\n\n      <Header\n        iconVariant="bottom"\n        title="WaitMe!"\n        unreadCount={unreadCount}\n        showBackButton={!!mode}\n        onBack={() => {\n          resetToLogo({ invalidate: false });\n        }}\n      />\n\n      <main className="fixed inset-0 top-0 bottom-0">\n        <AnimatePresence mode="wait">\n          {/* HOME PRINCIPAL */}\n          {!mode && (\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -20 }}\n              className="absolute inset-0 flex flex-col items-center justify-center overflow-hidden"\n            >\n              <div className="absolute inset-0 opacity-20 pointer-events-none overflow-hidden">\n                <div className="w-full h-full">\n                  <ParkingMap\n                    alerts={homeMapAlerts}\n                    userLocation={userLocation}\n                    userLocationOffsetY={120}\n                    zoomControl={false}\n                  />\n                </div>\n              </div>\n\n              <div className="absolute inset-0 bg-purple-900/40 pointer-events-none"></div>\n\n              <div className="text-center mb-4 w-full flex flex-col items-center relative top-[-20px] z-10 px-6">\n                <img\n                  loading="eager"\n                  decoding="async"\n                  fetchPriority="high"\n                  src={appLogo}\n                  alt="WaitMe!"\n                  onError={handleLogoError}\n                  className="w-[212px] h-[212px] mb-0 object-contain mt-[0px]"\n                />\n\n                <h1 className="text-4xl font-bold leading-none whitespace-nowrap relative top-[-65px]">\n                  Wait<span className="text-purple-500">Me!</span>\n                </h1>\n\n                <p className="text-xl font-bold mt-[3px] whitespace-nowrap relative top-[-65px]">\n                  Aparca donde te <span className="text-purple-500">avisen!</span>\n                </p>\n              </div>\n\n              {/* BOTONES */}\n              <div className="w-full max-w-sm mx-auto space-y-4 relative top-[-20px] z-10 px-6">\n                <Button\n                  onClick={() => setMode('search')}\n                  className="w-full h-20 bg-gray-900 hover:bg-gray-800 border border-gray-700 text-white text-lg font-medium rounded-2xl flex items-center justify-center gap-4 [&_svg]:!w-10 [&_svg]:!h-10"\n                >\n                  <MagnifierIconProfile color="#8b5cf6" size="w-14 h-14" />\n                  ¿ Dónde quieres aparcar ?\n                </Button>\n\n                <Button\n                  onClick={() => {\n                    // Al entrar en "Estoy aparcado aquí" debe autoubicar y rellenar calle.\n                    getCurrentLocation();\n                    setMode('create');\n                  }}\n                  className="w-full h-20 bg-purple-600 hover:bg-purple-700 text-white text-lg font-medium rounded-2xl flex items-center justify-center gap-4 [&_svg]:!w-20 [&_svg]:!h-14"\n                >\n                  <CarIconProfile color="#000000" size="w-20 h-14" />\n                  ¡ Estoy aparcado aquí !\n                </Button>\n              </div>\n            </motion.div>\n          )}\n\n          {/* DÓNDE QUIERES APARCAR (SIN SCROLL) */}\n          {mode === 'search' && (\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className="fixed inset-0 top-[60px] flex flex-col"\n              style={{ overflow: 'hidden', height: 'calc(100dvh - 60px)', paddingBottom: 'calc(env(safe-area-inset-bottom) + 88px)' }}\n            >\n              <div className="relative px-3 pt-[14px] pb-2 flex-none"\n                style={{ height: "280px" }}>\n                <div\n                  className="rounded-2xl border-2 border-purple-500 overflow-hidden h-full"\n                  style={{\n                    boxShadow:\n                      '0 0 30px rgba(168, 85, 247, 0.5), inset 0 0 20px rgba(168, 85, 247, 0.2)',\n                  }}\n                >\n                  <ParkingMap\n                    alerts={searchAlerts}\n                    onAlertClick={setSelectedAlert}\n                    userLocation={userLocation}\n                    selectedAlert={selectedAlert}\n                    showRoute={!!selectedAlert}\n                    zoomControl={true}\n                    className="h-full"\n                  />\n                </div>\n                {!showFilters && (\n                  <Button\n                    onClick={() => setShowFilters(true)}\n                    className="absolute top-5 right-7 z-[1000] bg-black/60 backdrop-blur-sm border border-purple-500/30 text-white hover:bg-purple-600"\n                    size="icon"\n                  >\n                    <SlidersHorizontal className="w-5 h-5" />\n                  </Button>\n                )}\n\n                <AnimatePresence>\n                  {showFilters && (\n                    <>\n                      <motion.div\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                        exit={{ opacity: 0 }}\n                        onClick={() => setShowFilters(false)}\n                        className="absolute inset-0 z-[999]"\n                      />\n                      <MapFilters\n                        filters={filters}\n                        onFilterChange={setFilters}\n                        onClose={() => setShowFilters(false)}\n                        alertsCount={searchAlerts.length}\n                      />\n                    </>\n                  )}\n                </AnimatePresence>\n              </div>\n\n              <div className="px-7 pt-[2px] pb-[2px] flex-shrink-0">\n                <div className="bg-gray-900/40 backdrop-blur-sm border-2 border-purple-500/50 rounded-xl px-3 py-[6px] flex items-center gap-2">\n                  <MapPin className="w-5 h-5 text-purple-400 flex-shrink-0" />\n                  <Input\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    placeholder="Buscar dirección..."\n                    className="bg-transparent border-0 text-white placeholder:text-gray-500 focus-visible:ring-0 focus-visible:ring-offset-0 h-7 text-sm p-0"\n                  />\n                </div>\n              </div>\n\n              <div className="flex-1 px-4 pt-2 pb-3 min-h-0 overflow-hidden flex items-start">\n                <div className="w-full h-full">\n                  <UserAlertCard\n                    alert={selectedAlert}\n                    isEmpty={!selectedAlert}\n                    onBuyAlert={handleBuyAlert}\n                    onChat={handleChat}\n                    onCall={handleCall}\n                    isLoading={buyAlertMutation.isPending}\n                    userLocation={userLocation}\n                  />\n                </div>\n              </div>\n            </motion.div>\n          )}\n\n          {/* ESTOY APARCADO AQUÍ (sin scroll) */}\n          {mode === 'create' && (\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className="fixed inset-0 top-[60px] flex flex-col"\n              style={{ overflow: 'hidden', height: 'calc(100dvh - 60px)', paddingBottom: 'calc(env(safe-area-inset-bottom) + 88px)' }}\n            >\n              <div className="relative px-3 pt-[14px] pb-2 flex-none"\n                style={{ height: "280px" }}>\n                <div\n                  className="rounded-2xl border-2 border-purple-500 overflow-hidden h-full"\n                  style={{\n                    boxShadow:\n                      '0 0 30px rgba(168, 85, 247, 0.5), inset 0 0 20px rgba(168, 85, 247, 0.2)',\n                  }}\n                >\n                  <ParkingMap\n                    useCenterPin={true}\n                    userLocation={userLocation}\n                    zoomControl={true}\n                    className="h-full"\n                    onMapMove={(center) => {\n                      setSelectedPosition({ lat: center[0], lng: center[1] });\n                    }}\n                    onMapMoveEnd={(center) => {\n                      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center[0]}&lon=${center[1]}`)\n                        .then((res) => res.json())\n                        .then((data) => {\n                          if (data?.address) {\n                            const road = data.address.road || data.address.street || '';\n                            const number = data.address.house_number || '';\n                            setAddress(number ? `${road}, ${number}` : road);\n                          }\n                        })\n                        .catch(() => {});\n                    }}\n                  />\n                </div>\n              </div>\n\n              <div className="px-7 pt-[2px] pb-[2px] flex-shrink-0">\n                <div className="bg-purple-600/20 border-2 border-purple-500/50 rounded-xl px-3 py-[2px]">\n                  <h3 className="text-white font-semibold text-center text-sm">\n                    ¿ Dónde estas aparcado ?\n                  </h3>\n                </div>\n              </div>\n\n              <div className="px-4 mt-[10px] flex-1 min-h-0 flex items-stretch">\n                <div className="w-full h-full">\n                  <CreateAlertCard\n                    address={address}\n                    onAddressChange={setAddress}\n                    onUseCurrentLocation={getCurrentLocation}\n                    useCurrentLocationLabel="Ubicación actual"\n                    onCreateAlert={async (data) => {\n                      if (!selectedPosition || !address) {\n                        alert('Por favor, selecciona una ubicación en el mapa');\n                        return;\n                      }\n\n                      const currentUser = user;\n                      const payload = {\n                        latitude: selectedPosition.lat,\n                        longitude: selectedPosition.lng,\n                        address: address,\n                        price: data.price,\n                        available_in_minutes: data.minutes,\n                        user_name: currentUser?.full_name?.split(' ')[0] || currentUser?.display_name || 'Usuario',\n                        user_photo: currentUser?.photo_url || null,\n                        car_brand: currentUser?.car_brand || 'Sin marca',\n                        car_model: currentUser?.car_model || 'Sin modelo',\n                        car_color: currentUser?.car_color || 'gris',\n                        car_plate: currentUser?.car_plate || '0000XXX',\n                        phone: currentUser?.phone || null,\n                        allow_phone_calls: currentUser?.allow_phone_calls || false\n                      };\n\n                      // Mensaje SIEMPRE: no depende de que la query haya terminado\n                      if (myActiveAlerts && myActiveAlerts.length > 0) {\n                        setOneActiveAlertOpen(true);\n                        return;\n                      }\n                      try {\n                        const uid = user?.id;\n                        const email = user?.email;\n                        if (uid || email) {\n                          const mine = uid\n                            ? await base44.entities.ParkingAlert.filter({ user_id: uid })\n                            : await base44.entities.ParkingAlert.filter({ user_email: email });\n                          const hasActive = (mine || []).some((a) => {\n                            const st = String(a?.status || '').toLowerCase();\n                            return st === 'active' || st === 'reserved';\n                          });\n                          if (hasActive) {\n                            setOneActiveAlertOpen(true);\n                            return;\n                          }\n                        }\n                      } catch {}\n\n                      setPendingPublishPayload(payload);\n                      setConfirmPublishOpen(true);\n                    }}\n                    isLoading={createAlertMutation.isPending}\n                  />\n                </div>\n              </div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </main>\n\n      <BottomNav />\n\n      {oneActiveAlertOpen && (\n  <div className="fixed inset-0 bg-black/70 z-[9999] flex items-center justify-center">\n    <div className="relative bg-gray-900 border-t-2 border-b-2 border-purple-500 max-w-sm w-[90%] rounded-xl p-6">\n      \n      <button\n        onClick={() => setOneActiveAlertOpen(false)}\n        className="absolute top-3 right-3 w-7 h-7 rounded-md bg-red-500/20 border border-red-500/50 flex items-center justify-center text-red-400 hover:bg-red-500/30 transition-colors"\n        type="button"\n      >\n        <X className="w-4 h-4" />\n      </button>\n\n      <div className="flex flex-col items-center text-center space-y-3">\n  <span className="text-white font-semibold text-base">\n    Ya tienes una alerta publicada.\n  </span>\n\n  <span className="text-gray-400 text-sm">\n    No puedes tener 2 alertas activas.\n  </span>\n</div>\n    </div>\n  </div>\n)}\n\n      <Dialog open={confirmPublishOpen} onOpenChange={(open) => {\n        setConfirmPublishOpen(open);\n        if (!open) setPendingPublishPayload(null);\n      }}>\n        <DialogContent\n          hideClose\n          className="bg-gray-900 border border-gray-800 text-white max-w-sm border-t-2 border-b-2 border-purple-500"\n        >\n          {/* Caja morada centrada */}\n          <div className="flex justify-center">\n            <div className="px-4 py-2 rounded-lg bg-purple-700/60 border border-purple-500/60">\n              <span className="text-white font-semibold text-sm">Vas a publicar una alerta:</span>\n            </div>\n          </div>\n\n          {/* Tarjeta incrustada */}\n          <div className="mt-4">\n            <div className="bg-gray-900 rounded-xl p-4 border-2 border-purple-500/50">\n              {/* Calle */}\n              <div className="flex items-center gap-2 text-sm">\n                <MapPin className="w-4 h-4 text-purple-400" />\n                <span className="text-white">En:</span>\n                <span className="text-purple-400 font-semibold">\n                  {pendingPublishPayload?.address || ''}\n                </span>\n              </div>\n\n              {/* Te vas en */}\n              <div className="flex items-center gap-2 text-sm mt-2">\n                <Clock className="w-4 h-4 text-purple-400" />\n                <span className="text-white">Te vas en:</span>\n                <span className="text-purple-400 font-semibold text-base">\n                  {pendingPublishPayload?.available_in_minutes ?? ''} minutos\n                </span>\n              </div>\n\n              {/* Precio */}\n              <div className="flex items-center gap-2 text-sm mt-2">\n                <Euro className="w-4 h-4 text-purple-400" />\n                <span className="text-white">Precio:</span>\n                <span className="text-purple-400 font-semibold text-base">\n                  {pendingPublishPayload?.price ?? ''} €\n                </span>\n              </div>\n\n              {/* Debes esperar... centrado */}\n              <div className="mt-3 text-center text-purple-400 font-bold text-base">\n                {(() => {\n                  const mins = Number(pendingPublishPayload?.available_in_minutes ?? 0);\n                  if (!mins) return null;\n                  const waitUntil = new Date(Date.now() + mins * 60 * 1000);\n                  const hhmm = waitUntil.toLocaleTimeString('es-ES', {\n                    timeZone: 'Europe/Madrid',\n                    hour: '2-digit',\n                    minute: '2-digit',\n                    hour12: false\n                  });\n                  return (\n                    <>\n                      <span className="text-purple-400">Debes esperar hasta las: </span>\n                      <span className="text-white">{hhmm}</span>\n                    </>\n                  );\n                })()}\n              </div>\n            </div>\n          </div>\n\n          {/* Botones: ancho solo del texto, Aceptar izquierda / Rechazar derecha */}\n          <DialogFooter className="flex flex-row items-center justify-center gap-3 mt-4 w-full">\n            <Button\n              onClick={() => {\n                if (!pendingPublishPayload) return;\n                setConfirmPublishOpen(false);\n                createAlertMutation.mutate(pendingPublishPayload);\n                setPendingPublishPayload(null);\n              }}\n              className="w-auto px-6 min-w-[118px] bg-purple-600 hover:bg-purple-700"\n            >\n              Aceptar\n            </Button>\n\n            <Button\n              onClick={() => {\n                setConfirmPublishOpen(false);\n                setPendingPublishPayload(null);\n              }}\n              className="w-auto px-6 min-w-[118px] bg-red-600 hover:bg-red-700 text-white"\n            >\n              Rechazar\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={confirmDialog.open} onOpenChange={(open) => setConfirmDialog({ open, alert: confirmDialog.alert })}>\n        <DialogContent className="bg-gray-900 border-gray-800 text-white max-w-sm">\n          <DialogHeader>\n            <DialogTitle className="text-xl">Confirmar reserva</DialogTitle>\n            <DialogDescription className="text-gray-400">\n              Vas a enviar una solicitud de reserva por{' '}\n              <span className="text-purple-400 font-bold">{confirmDialog.alert?.price}€</span> a{' '}\n              <span className="text-white font-medium">{confirmDialog.alert?.user_name}</span>\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className="bg-gray-800/50 rounded-xl p-4 space-y-2">\n            <p className="text-sm text-gray-400">\n              <span className="text-white">\n                {confirmDialog.alert?.car_brand} {confirmDialog.alert?.car_model}\n              </span>\n            </p>\n            <p className="text-sm text-gray-400">\n              Matrícula: <span className="text-white font-mono">{confirmDialog.alert?.car_plate}</span>\n            </p>\n            <p className="text-sm text-gray-400">\n              Se va en: <span className="text-purple-400">{confirmDialog.alert?.available_in_minutes} min</span>\n            </p>\n          </div>\n\n          <DialogFooter className="flex gap-3">\n            <Button variant="outline" onClick={() => setConfirmDialog({ open: false, alert: null })} className="flex-1 border-gray-700">\n              Cancelar\n            </Button>\n            <Button\n              onClick={() => buyAlertMutation.mutate(confirmDialog.alert)}\n              className="w-auto px-6 min-w-[118px] bg-purple-600 hover:bg-purple-700"\n            >\n              Enviar solicitud\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}